<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard del Sistema</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        .metric-card {
            border-radius: 12px;
            padding: 20px;
            background: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.07);
            transition: 0.2s ease;
        }
        .metric-card:hover {
            transform: translateY(-3px);
        }
        .chart-container {
            height: 260px;
        }
    </style>
</head>

<body class="bg-light">

<div class="container py-4">

    <a href="/" class="text-dark mb-3 d-inline-block">← Volver a la tienda</a>

    <h1 class="fw-bold mb-4">Sistema de reportes</h1>

    <!-- MÉTRICAS -->
    <div class="row g-3 mb-4">

        <div class="col-md-3">
            <div class="metric-card text-center">
                <h6 class="text-muted">Total de pedidos</h6>
                <h2 class="text-primary fw-bold">{{ datos.total_pedidos }}</h2>
            </div>
        </div>

        <div class="col-md-3">
            <div class="metric-card text-center">
                <h6 class="text-muted">Pedidos pagados</h6>
                <h2 class="text-success fw-bold">{{ datos.pedidos_pagados }}</h2>
            </div>
        </div>

        <div class="col-md-3">
            <div class="metric-card text-center">
                <h6 class="text-muted">Pedidos pendientes</h6>
                <h2 class="text-warning fw-bold">{{ datos.pedidos_pendientes }}</h2>
            </div>
        </div>

        <div class="col-md-3">
            <div class="metric-card text-center">
                <h6 class="text-muted">Total ingresos</h6>
                <h2 class="text-info fw-bold">${{ datos.total_ingresos }}</h2>
            </div>
        </div>

    </div>


    <!-- FILTRO DE FECHAS -->
    <form method="GET" class="card p-3 mb-4">
        <div class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label">Fecha inicio:</label>
                <input type="date" class="form-control" name="start_date" value="{{ request.GET.start_date }}">
            </div>
            <div class="col-md-4">
                <label class="form-label">Fecha fin:</label>
                <input type="date" class="form-control" name="end_date" value="{{ request.GET.end_date }}">
            </div>
            <div class="col-md-4">
                <button class="btn btn-primary w-100">Filtrar</button>
            </div>
        </div>
    </form>


    <!-- GRAFICOS -->
    <div class="row g-4 mb-4">

        <div class="col-md-4">
            <div class="card p-3">
                <h6 class="fw-bold">Pedidos por estado</h6>
                <div class="chart-container">
                    <canvas id="graficoEstados"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card p-3">
                <h6 class="fw-bold">Pedidos por plataforma</h6>
                <div class="chart-container">
                    <canvas id="graficoPlataforma"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card p-3">
                <h6 class="fw-bold">Productos más vendidos</h6>
                <div class="chart-container">
                    <canvas id="graficoProductos"></canvas>
                </div>
            </div>
        </div>

    </div>


    <!-- TABLA GENERAL -->
    <div class="card p-4 mb-5">
        <h4 class="fw-bold mb-3">Resumen general</h4>

        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Estado</th>
                        <th>Total pedidos</th>
                        <th>Plataforma</th>
                        <th>Producto</th>
                        <th>Cantidad vendida</th>
                    </tr>
                </thead>
                <tbody>
                    {% for est in datos.pedidos_por_estado %}
                    <tr>
                        <td>{{ est.estado }}</td>
                        <td>{{ est.total }}</td>
                        <td>—</td>
                        <td>—</td>
                        <td>—</td>
                    </tr>
                    {% endfor %}

                    {% for pl in datos.pedidos_por_plataforma %}
                    <tr>
                        <td>—</td>
                        <td>{{ pl.total }}</td>
                        <td>{{ pl.plataforma }}</td>
                        <td>—</td>
                        <td>—</td>
                    </tr>
                    {% endfor %}

                    {% for p in datos.productos_vendidos %}
                    <tr>
                        <td>—</td>
                        <td>—</td>
                        <td>—</td>
                        <td>{{ p.producto__nombre }}</td>
                        <td>{{ p.total }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

    </div>

</div>


<script>
const datos = {{ datos|safe }};

// ====== GRAFICO ESTADOS ======
new Chart(document.getElementById("graficoEstados"), {
    type: "bar",
    data: {
        labels: datos.pedidos_por_estado.map(e => e.estado),
        datasets: [{
            label: "Pedidos",
            data: datos.pedidos_por_estado.map(e => e.total)
        }]
    },
    options: { responsive: true, maintainAspectRatio: false }
});

// ====== GRAFICO PLATAFORMAS ======
new Chart(document.getElementById("graficoPlataforma"), {
    type: "doughnut",
    data: {
        labels: datos.pedidos_por_plataforma.map(e => e.plataforma),
        datasets: [{
            data: datos.pedidos_por_plataforma.map(e => e.total)
        }]
    },
    options: { responsive: true, maintainAspectRatio: false }
});

// ====== GRAFICO TOP PRODUCTOS ======
new Chart(document.getElementById("graficoProductos"), {
    type: "bar",
    data: {
        labels: datos.productos_vendidos.map(p => p["producto__nombre"]),
        datasets: [{
            label: "Unidades",
            data: datos.productos_vendidos.map(p => p.total)
        }]
    },
    options: { responsive: true, maintainAspectRatio: false }
});
</script>

</body>
</html>
